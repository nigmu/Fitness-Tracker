<!DOCTYPE html>
<html>
<head>
    <title>Fitness Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('food')">Food</button>
            <button class="tab" onclick="switchTab('exercise')">Exercise</button>
            <button class="tab" onclick="switchTab('body')">Body</button>
        </div>
        
        <div id="controls">
            <div class="control-group">
                <input type="text" id="new-column" placeholder="New column name">
                <button onclick="addColumn()">Add Column</button>
            </div>
            <button onclick="addRow()">Add New Row</button>
        </div>

        <div id="table-container"></div>

        <div id="confirmation-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <p id="modal-message"></p>
                <div class="modal-buttons">
                    <button onclick="confirmAction()">Confirm</button>
                    <button onclick="closeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTable = 'food';
        let activeInput = null;
        let pendingAction = null;

        function switchTab(table) {
            currentTable = table;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${table}')"]`).classList.add('active');
            loadTable();
        }

        async function loadTable() {
            const response = await fetch(`/api/${currentTable}/data`);
            const { data } = await response.json();
            renderTable(data);
        }

        function renderTable(data) {
            const container = document.getElementById('table-container');
            container.innerHTML = '';
            
            if (!data.length) {
                container.innerHTML = 'No data available';
                return;
            }

            const table = document.createElement('table');
            const headerRow = document.createElement('tr');
            
            // Headers (ID first, Date second, then others)
            const columns = ['id', 'date', ...Object.keys(data[0]).filter(k => !['id', 'date'].includes(k))];
            columns.forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                if (!['id', 'date'].includes(key)) {
                    th.onclick = () => showDeleteColumnModal(key);
                }
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            // Rows (newest first)
            data.reverse().forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(key => {
                    const td = document.createElement('td');
                    if (key === 'id') {
                        td.onclick = () => showDeleteRowModal(row.id);
                    } else if (key !== 'date') {
                        td.onclick = () => startEditing(td);
                    }
                    td.textContent = row[key] || '';
                    td.setAttribute('data-column', key);
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });

            container.appendChild(table);
        }

        function startEditing(cell) {
            if (activeInput) return;
            
            const initialValue = cell.textContent;
            const input = document.createElement('input');
            input.value = initialValue;
            
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            activeInput = input;

            const save = async () => {
                await saveCell(cell, input.value);
                activeInput = null;
                cell.textContent = input.value.trim();
            };

            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter') await save();
            });

            input.addEventListener('blur', async () => {
                await save();
            });
        }

        async function saveCell(cell, value) {
            const rowId = cell.parentElement.querySelector('td:first-child').textContent;
            const column = cell.getAttribute('data-column');
            
            await fetch(`/api/${currentTable}/update-cell`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    row_id: rowId,
                    column: column,
                    value: value.trim()
                })
            });
        }

        function showDeleteRowModal(rowId) {
            document.getElementById('modal-message').textContent = `Delete row #${rowId}?`;
            pendingAction = async () => {
                await fetch(`/api/${currentTable}/delete-row`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ row_id: rowId })
                });
                loadTable();
            };
            document.getElementById('confirmation-modal').style.display = 'block';
        }

        function showDeleteColumnModal(column) {
            document.getElementById('modal-message').textContent = `Delete column "${column}"?`;
            pendingAction = async () => {
                await fetch(`/api/${currentTable}/delete-column`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: column })
                });
                loadTable();
            };
            document.getElementById('confirmation-modal').style.display = 'block';
        }

        function confirmAction() {
            if (pendingAction) pendingAction();
            closeModal();
        }

        function closeModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
            pendingAction = null;
        }

        async function addRow() {
            await fetch(`/api/${currentTable}/add-row`, { method: 'POST' });
            loadTable();
        }

        async function addColumn() {
            const name = document.getElementById('new-column').value;
            if (name) {
                await fetch(`/api/${currentTable}/add-column`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                document.getElementById('new-column').value = '';
                loadTable();
            }
        }

        // Initial load
        loadTable();
    </script>
</body>
</html>